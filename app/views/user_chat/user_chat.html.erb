<header class="header">
  <div class = "general">
    <div class="left">
      <div class = "hello">
        <h3 class="user"><%= current_user.email%></h3>
      </div>
    </div>
    <div class="right">
      <div class="margin">
      <%= link_to 'Go back', root_path, class: "btn btn-light btn-outline-warning"%>
    </div>
      <div class="margin">
        <%= link_to 'Exit', destroy_user_session_path, data: {confirm: "Are you sure?"}, :method => :delete, class: "btn btn-light btn-outline-danger" %>
      </div>
    </div>
  </div>
</header>

<div class="for_all">
  <div class="output">
    <div class="name">
      <h3><%= @user.email %></h3>
    </div>
    <div class="messages">
        <%= render 'message'  %>
    </div>
  </div>
  <div class="input" data-id="<%= @user.id %>">

    <%= form_tag user_create_path, id: "message_form" do %>
      <p>
        <br>
        <%= text_field_tag :body, class: "text_field", placeholder: "Write something...", id: "input", type: "text", required: 'required'%>
        <%= hidden_field_tag :user_id, @user.id %>
      </p>

      <p>
        <%= button_tag 'Send', class: "btn btn-light btn-outline-secondary", id: "button_send_message"%>
      </p>
    <% end %>
  </div>
</div>

<script>
    const data_id = document.querySelector(".input");
    let data_set = data_id.dataset.id;
    const url = '/user_create?user_id=' + data_set
    const csrf = document.querySelector('meta[name="csrf-token"]').content;
    console.log(csrf)


    let send_form = document.getElementById("message_form")
    send_form.addEventListener("submit", async evt => {
        evt.preventDefault();
        let data_for_post = document.getElementById('body').value
        await postData(url, data_for_post)
    } );


    async function postData(url, data){
        await fetch(url, {
            method: 'POST',
            mode: 'cors',
            credentials: 'same-origin',
            cache: 'no-cache',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': csrf
            },
            body: JSON.stringify(data)
        });
    }


</script>
